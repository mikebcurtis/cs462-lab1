/*
 * File: app/controller/Controller.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.Controller', {
    extend: 'Ext.app.Controller',

    stores: [
        'Users',
        'CurrentUser'
    ],

    refs: [
        {
            ref: 'loginNameTextfield',
            selector: 'loginwindow #loginNameTextfield'
        },
        {
            ref: 'loginPasswordTextfield',
            selector: 'loginwindow #loginPasswordTextfield'
        },
        {
            ref: 'createNameTextfield',
            selector: 'createaccountwindow #createNameTextfield'
        },
        {
            ref: 'createPasswordTextfield',
            selector: 'createaccountwindow #createPasswordTextfield'
        },
        {
            ref: 'welcomeText',
            selector: '#usersPanel #welcomeText'
        },
        {
            ref: 'loginButton',
            selector: '#usersPanel #loginButton'
        },
        {
            ref: 'logoutButton',
            selector: '#usersPanel #logoutButton'
        }
    ],

    onLoginWindowButtonClick: function(button, e, eOpts) {
        var name = this.getLoginNameTextfield().getRawValue();
        var pass = this.getLoginPasswordTextfield().getRawValue();

        var currentUserStore = this.getCurrentUserStore();

        var welcomeText = this.getWelcomeText();
        var loginButton = this.getLoginButton();
        var logoutButton = this.getLogoutButton();

        var window = button.up('window');

        this.getUsersStore().each(function(user){
            console.log("comparing " + user.get('name') + " and " + name + " : pass = " + user.get('pass') + " given = " + pass); // DEBUG
            if (user.get('name') == name && user.get('pass') == pass) {
                currentUserStore.removeAll();
                currentUserStore.add(user);

                welcomeText.setText("Welcome " + name + "!");

                loginButton.setDisabled(true);
                logoutButton.setDisabled(false);

                window.destroy();

                return false;
            }
        });
    },

    onLoginButtonClick: function(button, e, eOpts) {
        var window = Ext.create('widget.loginwindow');
        window.show();
    },

    onLogoutButtonClick: function(button, e, eOpts) {
        this.getCurrentUserStore().removeAll();
        button.setDisabled(true);
        this.getLoginButton().setDisabled(false);
        this.getWelcomeText().setText("");
    },

    init: function(application) {
        this.control({
            "loginwindow #loginWindowButton": {
                click: this.onLoginWindowButtonClick
            },
            "#usersPanel #loginButton": {
                click: this.onLoginButtonClick
            },
            "#usersPanel #logoutButton": {
                click: this.onLogoutButtonClick
            }
        });
    }

});
